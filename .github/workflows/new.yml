name: Deploy PHP to AWS EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: 'ap-northeast-3'
  WEB_ROOT: '/var/www/html'
  RDS_ENDPOINT: ${{ secrets.RDS_HOST }}
  DB_NAME: ${{ secrets.DB_NAME }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Increase timeout
    strategy:
      max-parallel: 1
      fail-fast: false

    steps:
    - name: Check GitHub Runner Status
      run: |
        echo "Checking GitHub status..."
        curl -s https://www.githubstatus.com/api/v2/status.json | jq -r '.status.description'
        echo "Proceeding with workflow..."

    - name: Checkout code
      uses: actions/checkout@v3
      timeout-minutes: 5

    - name: Verify Runner Environment
      run: |
        echo "Runner OS: $RUNNER_OS"
        echo "Runner Temp: $RUNNER_TEMP"
        df -h
        free -m

    - name: Check for composer.json
      id: check-composer
      run: |
        if [ -f "composer.json" ]; then
          echo "composer_exists=true" >> $GITHUB_OUTPUT
        else
          echo "composer_exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Install PHP dependencies
      if: steps.check-composer.outputs.composer_exists == 'true'
      timeout-minutes: 10
      run: |
        sudo apt-get update
        sudo apt-get install -y zip unzip jq
        curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
        composer install --no-dev --optimize-autoloader --no-interaction --no-progress

    # Rest of your workflow steps...
    # (Include all the remaining steps from the previous working version)